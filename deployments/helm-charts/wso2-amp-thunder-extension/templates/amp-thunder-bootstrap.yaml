{{- $scheme := ternary "http" "https" .Values.thunder.configuration.server.httpOnly }}
{{- $curlInsecure := ternary "" "-k" .Values.thunder.configuration.server.httpOnly }}
{{- $port := .Values.thunder.configuration.server.port }}
{{- $thunderUrl := printf "%s://localhost:%d" $scheme (int $port) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: amp-thunder-bootstrap
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/component: thunder-bootstrap
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-10"
data:
  50-amp-api-client.sh: |
    #!/bin/bash
    set -e

    log_info "Checking if application '{{ .Values.thunder.bootstrap.ampApiClient.name }}' already exists..."
    existing_apps=$(curl {{ $curlInsecure }} -s --max-time 10 "{{ $thunderUrl }}/applications")

    # Extract application ID by matching client_id in JSON response
    # Handles both {"client_id":"...","id":"..."} and {"id":"...","client_id":"..."} field orderings
    app_id=$(echo "$existing_apps" \
      | grep -o '"client_id":"{{ .Values.thunder.bootstrap.ampApiClient.clientId }}"[^}]*"id":"[^"]*"\|"id":"[^"]*"[^}]*"client_id":"{{ .Values.thunder.bootstrap.ampApiClient.clientId }}"' \
      | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)

    # Define the application payload
    APP_PAYLOAD='{
      "name": "{{ .Values.thunder.bootstrap.ampApiClient.name }}",
      "description": "{{ .Values.thunder.bootstrap.ampApiClient.description }}",
      "auth_flow_graph_id": "{{ .Values.thunder.bootstrap.ampApiClient.authFlowGraphId }}",
      "inbound_auth_config": [
        {
          "type": "oauth2",
          "config": {
            "client_id": "{{ .Values.thunder.bootstrap.ampApiClient.clientId }}",
            "client_secret": "{{ .Values.thunder.bootstrap.ampApiClient.clientSecret }}",
            "grant_types": {{ .Values.thunder.bootstrap.ampApiClient.grantTypes | toJson }},
            "token_endpoint_auth_method": "{{ .Values.thunder.bootstrap.ampApiClient.tokenEndpointAuthMethod }}",
            "pkce_required": {{ .Values.thunder.bootstrap.ampApiClient.pkceRequired }},
            "public_client": {{ .Values.thunder.bootstrap.ampApiClient.publicClient }},
            "token": {
              "access_token": {
                "validity_period": {{ .Values.thunder.bootstrap.ampApiClient.accessTokenValidityPeriod }}
              }
            }
          }
        }
      ]
    }'

    if echo "$existing_apps" | grep -q '"client_id":"{{ .Values.thunder.bootstrap.ampApiClient.clientId }}"'; then
      log_info "Application '{{ .Values.thunder.bootstrap.ampApiClient.name }}' already exists (id: $app_id), updating..."
      curl {{ $curlInsecure }} --location -X PUT "{{ $thunderUrl }}/applications/$app_id" \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "Application '{{ .Values.thunder.bootstrap.ampApiClient.name }}' updated successfully"
    else
      log_info "Application '{{ .Values.thunder.bootstrap.ampApiClient.name }}' does not exist, creating..."
      curl {{ $curlInsecure }} --location "{{ $thunderUrl }}/applications" \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "Application '{{ .Values.thunder.bootstrap.ampApiClient.name }}' created successfully"
    fi

  51-amp-console-app.sh: |
    #!/bin/bash
    set -e

    log_info "Checking if application '{{ .Values.thunder.bootstrap.ampConsoleClient.name }}' already exists..."
    existing_apps=$(curl {{ $curlInsecure }} -s --max-time 10 "{{ $thunderUrl }}/applications")

    # Extract application ID by matching client_id in JSON response
    # Handles both {"client_id":"...","id":"..."} and {"id":"...","client_id":"..."} field orderings
    app_id=$(echo "$existing_apps" \
      | grep -o '"client_id":"{{ .Values.thunder.bootstrap.ampConsoleClient.clientId }}"[^}]*"id":"[^"]*"\|"id":"[^"]*"[^}]*"client_id":"{{ .Values.thunder.bootstrap.ampConsoleClient.clientId }}"' \
      | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)

    # Define the application payload
    APP_PAYLOAD='{
      "name": "{{ .Values.thunder.bootstrap.ampConsoleClient.name }}",
      "description": "{{ .Values.thunder.bootstrap.ampConsoleClient.description }}",
      "auth_flow_graph_id": "{{ .Values.thunder.bootstrap.ampConsoleClient.authFlowGraphId }}",
      "inbound_auth_config": [
        {
          "type": "oauth2",
          "config": {
            "client_id": "{{ .Values.thunder.bootstrap.ampConsoleClient.clientId }}",
            "client_secret": "{{ .Values.thunder.bootstrap.ampConsoleClient.clientSecret }}",
            "redirect_uris": {{ .Values.thunder.bootstrap.ampConsoleClient.redirectUris | toJson }},
            "grant_types": {{ .Values.thunder.bootstrap.ampConsoleClient.grantTypes | toJson }},
            "response_types": {{ .Values.thunder.bootstrap.ampConsoleClient.responseTypes | toJson }},
            "token_endpoint_auth_method": "{{ .Values.thunder.bootstrap.ampConsoleClient.tokenEndpointAuthMethod }}",
            "pkce_required": {{ .Values.thunder.bootstrap.ampConsoleClient.pkceRequired }},
            "public_client": {{ .Values.thunder.bootstrap.ampConsoleClient.publicClient }},
            "token": {
              "issuer": "{{ .Values.thunder.bootstrap.ampConsoleClient.tokenIssuer }}",
              "access_token": {
                "validity_period": {{ .Values.thunder.bootstrap.ampConsoleClient.accessTokenValidityPeriod }},
                "user_attributes": {{ .Values.thunder.bootstrap.ampConsoleClient.userAttributes | toJson }}
              },
              "id_token": {
                "validity_period": {{ .Values.thunder.bootstrap.ampConsoleClient.idTokenValidityPeriod }},
                "user_attributes": {{ .Values.thunder.bootstrap.ampConsoleClient.userAttributes | toJson }},
                "scope_claims": {
                  "groups": [
                    "groups"
                  ],
                  "profile": [
                    "username",
                    "given_name",
                    "family_name",
                    "picture"
                  ]
                }
              }
            }
          }
        }
      ],
      "allowed_user_types": {{ .Values.thunder.bootstrap.ampConsoleClient.allowed_user_types | toJson }},
    }'

    if echo "$existing_apps" | grep -q '"client_id":"{{ .Values.thunder.bootstrap.ampConsoleClient.clientId }}"'; then
      log_info "Application '{{ .Values.thunder.bootstrap.ampConsoleClient.name }}' already exists (id: $app_id), updating..."
      curl {{ $curlInsecure }} --location -X PUT "{{ $thunderUrl }}/applications/$app_id" \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "Application '{{ .Values.thunder.bootstrap.ampConsoleClient.name }}' updated successfully"
    else
      log_info "Application '{{ .Values.thunder.bootstrap.ampConsoleClient.name }}' does not exist, creating..."
      curl {{ $curlInsecure }} --location "{{ $thunderUrl }}/applications" \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "Application '{{ .Values.thunder.bootstrap.ampConsoleClient.name }}' created successfully"
    fi
  52-user-schema-and-users.sh: |
    #!/bin/bash
    set -e

    # First, create the default OU if it doesn't exist
    log_info "Checking if organization unit '{{ .Values.thunder.bootstrap.organizationUnit.handle }}' exists..."
    if ! curl {{ $curlInsecure }} -s --max-time 10 '{{ $thunderUrl }}/organization-units' | grep -q '"handle":"{{ .Values.thunder.bootstrap.organizationUnit.handle }}"'; then
      log_info "Creating organization unit '{{ .Values.thunder.bootstrap.organizationUnit.name }}'..."
      curl {{ $curlInsecure }} --location '{{ $thunderUrl }}/organization-units' \
        --header 'Content-Type: application/json' \
        --header 'Accept: application/json' \
        --data '{
          "name": "{{ .Values.thunder.bootstrap.organizationUnit.name }}",
          "handle": "{{ .Values.thunder.bootstrap.organizationUnit.handle }}",
          "description": "{{ .Values.thunder.bootstrap.organizationUnit.description }}"
        }' \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5
      log_info "Organization unit '{{ .Values.thunder.bootstrap.organizationUnit.name }}' created successfully"
    else
      log_info "Organization unit '{{ .Values.thunder.bootstrap.organizationUnit.handle }}' already exists"
    fi

    # Get the organization unit ID by matching handle in JSON response
    # Handles both {"handle":"...","id":"..."} and {"id":"...","handle":"..."} field orderings
    ORG_UNIT_ID=$(curl {{ $curlInsecure }} -s --max-time 10 '{{ $thunderUrl }}/organization-units' \
      | grep -o '"handle":"{{ .Values.thunder.bootstrap.organizationUnit.handle }}"[^}]*"id":"[^"]*"\|"id":"[^"]*"[^}]*"handle":"{{ .Values.thunder.bootstrap.organizationUnit.handle }}"' \
      | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
    log_info "Using organization unit ID: $ORG_UNIT_ID"

    log_info "Checking if user schema '{{ .Values.thunder.bootstrap.userSchema.name }}' already exists..."
    existing_schemas=$(curl {{ $curlInsecure }} -s --max-time 10 '{{ $thunderUrl }}/user-schemas')

    if echo "$existing_schemas" | grep -q '"name":"{{ .Values.thunder.bootstrap.userSchema.name }}"'; then
      log_info "User schema '{{ .Values.thunder.bootstrap.userSchema.name }}' already exists, skipping creation"
    else
      log_info "User schema does not exist, creating user schema '{{ .Values.thunder.bootstrap.userSchema.name }}'..."
      curl {{ $curlInsecure }} --location '{{ $thunderUrl }}/user-schemas' \
        --header 'accept: application/json' \
        --header 'Content-Type: application/json' \
        --data "{
          \"name\": \"{{ .Values.thunder.bootstrap.userSchema.name }}\",
          \"ouId\": \"$ORG_UNIT_ID\",
          \"allowSelfRegistration\": {{ .Values.thunder.bootstrap.userSchema.allowSelfRegistration }},
          \"schema\": {
            \"username\": {
              \"type\": \"string\",
              \"required\": true
            },
            \"password\": {
              \"type\": \"string\",
              \"required\": true
            },
            \"given_name\": {
              \"type\": \"string\"
            },
            \"family_name\": {
              \"type\": \"string\"
            },
            \"groups\": {
              \"type\": \"array\",
              \"items\": {\"type\": \"string\"}
            }
          }
        }" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "User schema created successfully"
    fi

    # Create default users
    {{- if .Values.thunder.bootstrap.defaultUsers }}
    {{- range .Values.thunder.bootstrap.defaultUsers }}
    log_info "Checking if user '{{ .username }}' already exists..."
    existing_users=$(curl {{ $curlInsecure }} -s --max-time 10 '{{ $thunderUrl }}/users')

    if echo "$existing_users" | grep -q '"username":"{{ .username }}"'; then
      log_info "User '{{ .username }}' already exists, skipping creation"
    else
      log_info "User does not exist, creating user '{{ .username }}'..."
      curl {{ $curlInsecure }} --location '{{ $thunderUrl }}/users' \
        --header 'accept: application/json' \
        --header 'Content-Type: application/json' \
        --data "{
          \"type\": \"{{ $.Values.thunder.bootstrap.userSchema.name }}\",
          \"organizationUnit\": \"$ORG_UNIT_ID\",
          \"attributes\": {
            \"username\": \"{{ .username }}\",
            \"password\": \"{{ .password }}\",
            \"given_name\": \"{{ .givenName }}\",
            \"family_name\": \"{{ .familyName }}\",
            \"groups\": {{ .groups | toJson | replace "\"" "\\\"" }}
          }
        }" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "User '{{ .username }}' created successfully"
    fi
    {{- end }}
    {{- end }}
