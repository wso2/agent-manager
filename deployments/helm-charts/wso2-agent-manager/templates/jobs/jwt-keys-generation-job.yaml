{{- if and .Values.jwtKeysGeneration.enabled (not .Values.jwtSigning.existingSecret) }}
apiVersion: batch/v1
kind: Job
metadata:
  name: amp-jwt-keys-generation
  labels:
    {{- include "agent-management-platform.labels" . | nindent 4 }}
    app.kubernetes.io/component: jwt-keys-generation
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: {{ .Values.jwtKeysGeneration.backoffLimit }}
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      name: amp-jwt-keys-generation
      labels:
        {{- include "agent-management-platform.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: jwt-keys-generation
    spec:
      {{- include "agent-management-platform.imagePullSecrets" . | nindent 6 }}
      serviceAccountName: {{ include "agent-management-platform.serviceAccountName" . }}
      restartPolicy: Never
      {{- with .Values.jwtKeysGeneration.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: jwt-keys-generation
          {{- with .Values.jwtKeysGeneration.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          image: "{{ .Values.jwtKeysGeneration.image.repository }}:{{ .Values.jwtKeysGeneration.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.jwtKeysGeneration.image.pullPolicy }}
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail
              
              # Check if secret already exists
              if kubectl get secret {{ include "agent-management-platform.jwtKeysSecretName" . }} -n {{ .Release.Namespace }} &>/dev/null; then
                echo "JWT keys Secret already exists, skipping generation"
                exit 0
              fi
              
              echo "Generating JWT signing keys..."
              cd /app
              /app/scripts/gen_keys.sh
              
              # Verify keys were generated
              if [[ ! -f /app/keys/private.pem ]] || [[ ! -f /app/keys/public.pem ]] || [[ ! -f /app/keys/public-keys-config.json ]]; then
                echo "ERROR: Key generation failed - missing key files"
                exit 1
              fi
              
              echo "Creating Kubernetes Secret with JWT keys..."
              kubectl create secret generic {{ include "agent-management-platform.jwtKeysSecretName" . }} \
                -n {{ .Release.Namespace }} \
                --from-file=private.pem=/app/keys/private.pem \
                --from-file=public.pem=/app/keys/public.pem \
                --from-file=public-keys-config.json=/app/keys/public-keys-config.json \
                --dry-run=client -o yaml | \
              kubectl apply -f -
              
              # Add annotation for tracking
              kubectl annotate secret {{ include "agent-management-platform.jwtKeysSecretName" . }} \
                -n {{ .Release.Namespace }} \
                amp.wso2.com/keys-version="1" \
                amp.wso2.com/generated-at="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                --overwrite
              
              echo "JWT keys Secret created successfully"
          {{- with .Values.jwtKeysGeneration.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
{{- end }}
