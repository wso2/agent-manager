# This is copied from https://raw.githubusercontent.com/openchoreo/openchoreo/release-v0.9/install/k3d/single-cluster/config.yaml\
# Only modification is changing the cluster name to openchoreo-local-v0.9
apiVersion: k3d.io/v1alpha5
kind: Simple
metadata:
  name: openchoreo-local-v0.9
image: rancher/k3s:v1.32.9-k3s1
servers: 1
agents: 0
kubeAPI:
  hostPort: "6550"
# Single cluster mode exposes all plane port ranges for consistency with multi-cluster setup
ports:
  # Control Plane uses port range 8xxx
  # HTTP traffic to OpenChoreo UI and API (Traefik LoadBalancer on port 80)
  - port: 8080:8080
    nodeFilters:
      - loadbalancer
  # HTTPS traffic to OpenChoreo UI and API (Traefik LoadBalancer on port 443)
  - port: 8443:8443
    nodeFilters:
      - loadbalancer
  # Data Plane uses port range 19xxx (matches kind and other cluster setups)
  # HTTP traffic to workloads via Gateway
  - port: 19080:19080
    nodeFilters:
      - loadbalancer
  # HTTPS traffic to workloads via Gateway
  - port: 19443:19443
    nodeFilters:
      - loadbalancer
  # Build Plane uses port range 10xxx
  # Argo Workflows UI for development testing
  - port: 10081:2746
    nodeFilters:
      - loadbalancer
  # Container Registry for storing built images
  - port: 10082:5000
    nodeFilters:
      - loadbalancer
  # Observability Plane uses port range 11xxx
  # Observer API
  - port: 11080:8080
    nodeFilters:
      - loadbalancer
  # OpenSearch Dashboard
  - port: 11081:5601
    nodeFilters:
      - loadbalancer
  # OpenSearch API for Fluent Bit data pushing
  - port: 11082:9200
    nodeFilters:
      - loadbalancer
options:
  k3s:
    extraArgs:
      # Add host.k3d.internal to API server TLS certificate SANs.
      # This allows consistent DataPlane configuration across single and multi-cluster setups
      # where Control Plane pods can access the API server via host.k3d.internal:6550
      - arg: "--tls-san=host.k3d.internal --disable=traefik"
        nodeFilters:
          - server:*
      # Configure kubelet eviction thresholds to prevent resource exhaustion
      - arg: "--kubelet-arg=eviction-hard=imagefs.available<1%,nodefs.available<1%"
        nodeFilters:
          - server:*
      - arg: "--kubelet-arg=eviction-minimum-reclaim=imagefs.available=1%,nodefs.available=1%"
        nodeFilters:
          - server:*
# Configure insecure registries for HTTP access
# Allows kubelet to pull images from Build Plane registry via HTTP
registries:
  config: |
    mirrors:
      "host.k3d.internal:10082":
        endpoint:
          - http://host.k3d.internal:10082
