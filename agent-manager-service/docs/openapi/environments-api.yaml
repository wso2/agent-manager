openapi: 3.0.3
info:
  title: Agent Manager - Environments API
  description: |
    API for managing gateway environments within the Agent Manager platform.

    Environments represent logical deployment stages (dev, staging, production) for organizing
    and grouping AI gateways. Each environment can have multiple gateways mapped to it.

    **Key Features:**
    - Create and manage environments (dev, staging, production, etc.)
    - List all environments for an organization
    - Update environment metadata
    - Delete environments (soft delete)
    - View gateways mapped to an environment

    **Security:**
    - All endpoints require JWT authentication
    - Organization-level isolation

  version: 1.0.0
  contact:
    name: WSO2 Support
    url: https://wso2.com/support
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: http://localhost:8080
    description: Local development
  - url: https://api.agent-manager.wso2.com
    description: Production

tags:
  - name: Environments
    description: Gateway environment management operations

security:
  - bearerAuth: []

paths:
  # ============================================
  # ENVIRONMENT ENDPOINTS
  # ============================================

  /orgs/{orgName}/environments:
    parameters:
      - $ref: '#/components/parameters/orgNamePath'

    get:
      tags:
        - Environments
      summary: List all environments
      description: Retrieve a paginated list of all environments for the organization
      operationId: listEnvironments
      parameters:
        - $ref: '#/components/parameters/limitQuery'
        - $ref: '#/components/parameters/offsetQuery'
      responses:
        '200':
          description: Successfully retrieved environment list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvironmentListResponse'
              example:
                environments:
                  - uuid: 550e8400-e29b-41d4-a716-446655440000
                    organizationId: 123e4567-e89b-12d3-a456-426614174000
                    name: development
                    displayName: Development Environment
                    description: Environment for development and testing
                    createdAt: '2026-01-15T10:30:00Z'
                    updatedAt: '2026-01-15T10:30:00Z'
                  - uuid: 660e8400-e29b-41d4-a716-446655440001
                    organizationId: 123e4567-e89b-12d3-a456-426614174000
                    name: production
                    displayName: Production Environment
                    description: Production environment for live agents
                    createdAt: '2026-01-20T14:00:00Z'
                    updatedAt: '2026-01-20T14:00:00Z'
                total: 2
                limit: 20
                offset: 0
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Environments
      summary: Create a new environment
      description: |
        Create a new gateway environment for the organization.

        Environment names must be unique within an organization and should be lowercase
        alphanumeric with hyphens (e.g., dev, staging, production).
      operationId: createEnvironment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEnvironmentRequest'
            example:
              name: staging
              displayName: Staging Environment
              description: Pre-production staging environment
      responses:
        '201':
          description: Environment created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GatewayEnvironmentResponse'
              example:
                uuid: 770e8400-e29b-41d4-a716-446655440002
                organizationId: 123e4567-e89b-12d3-a456-426614174000
                name: staging
                displayName: Staging Environment
                description: Pre-production staging environment
                createdAt: '2026-02-08T10:30:00Z'
                updatedAt: '2026-02-08T10:30:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /orgs/{orgName}/environments/{envID}:
    parameters:
      - $ref: '#/components/parameters/orgNamePath'
      - $ref: '#/components/parameters/envIDPath'

    get:
      tags:
        - Environments
      summary: Get environment details
      description: Retrieve detailed information about a specific environment
      operationId: getEnvironment
      responses:
        '200':
          description: Successfully retrieved environment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GatewayEnvironmentResponse'
              example:
                uuid: 550e8400-e29b-41d4-a716-446655440000
                organizationId: 123e4567-e89b-12d3-a456-426614174000
                name: production
                displayName: Production Environment
                description: Production environment for critical AI agents
                createdAt: '2026-01-15T10:30:00Z'
                updatedAt: '2026-01-20T14:45:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Environments
      summary: Update environment
      description: |
        Update an existing environment's properties.

        You can update the display name and description. The environment name cannot be changed.
      operationId: updateEnvironment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEnvironmentRequest'
            example:
              displayName: Production Environment (US-East)
              description: Production environment for US East region
      responses:
        '200':
          description: Environment updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GatewayEnvironmentResponse'
              example:
                uuid: 550e8400-e29b-41d4-a716-446655440000
                organizationId: 123e4567-e89b-12d3-a456-426614174000
                name: production
                displayName: Production Environment (US-East)
                description: Production environment for US East region
                createdAt: '2026-01-15T10:30:00Z'
                updatedAt: '2026-02-08T15:30:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Environments
      summary: Delete environment
      description: |
        Soft delete an environment. This will also remove all gateway-environment mappings
        associated with this environment.

        The environment can be restored if needed by contacting support.
      operationId: deleteEnvironment
      responses:
        '204':
          description: Environment deleted successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /orgs/{orgName}/environments/{envID}/gateways:
    parameters:
      - $ref: '#/components/parameters/orgNamePath'
      - $ref: '#/components/parameters/envIDPath'

    get:
      tags:
        - Environments
      summary: Get environment gateways
      description: |
        List all gateways mapped to a specific environment.

        This endpoint returns all gateways that are available in this environment,
        useful for understanding which gateways can be used by agents in this environment.
      operationId: getEnvironmentGateways
      responses:
        '200':
          description: Successfully retrieved gateway list
          content:
            application/json:
              schema:
                type: object
                properties:
                  gateways:
                    type: array
                    items:
                      $ref: '#/components/schemas/GatewayResponse'
              example:
                gateways:
                  - uuid: 7c4a8d09-ca3f-4b0a-82e9-2e85b96dd8a7
                    organizationId: 123e4567-e89b-12d3-a456-426614174000
                    name: ai-gateway-prod
                    displayName: Production AI Gateway
                    gatewayType: EGRESS
                    vhost: api.production.example.com
                    region: us-east-1
                    isCritical: true
                    status: ACTIVE
                    createdAt: '2026-01-15T10:30:00Z'
                    updatedAt: '2026-02-01T08:00:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

# ============================================
# COMPONENTS
# ============================================

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authentication

  parameters:
    orgNamePath:
      name: orgName
      in: path
      required: true
      description: Organization name/handle
      schema:
        type: string
        pattern: '^[a-z0-9-]+$'
        minLength: 1
        maxLength: 64
      example: acme

    envIDPath:
      name: envID
      in: path
      required: true
      description: Environment UUID or name
      schema:
        type: string
      example: production

    limitQuery:
      name: limit
      in: query
      description: Maximum number of results to return
      schema:
        type: integer
        format: int32
        minimum: 1
        maximum: 100
        default: 20
      example: 20

    offsetQuery:
      name: offset
      in: query
      description: Number of results to skip
      schema:
        type: integer
        format: int32
        minimum: 0
        default: 0
      example: 0

  schemas:
    # ============================================
    # ENVIRONMENT SCHEMAS
    # ============================================

    GatewayEnvironmentResponse:
      type: object
      required:
        - uuid
        - organizationId
        - name
        - displayName
        - createdAt
        - updatedAt
      properties:
        uuid:
          type: string
          format: uuid
          description: Unique identifier for the environment
          example: 550e8400-e29b-41d4-a716-446655440000
        organizationId:
          type: string
          format: uuid
          description: Organization UUID
          example: 123e4567-e89b-12d3-a456-426614174000
        name:
          type: string
          description: Unique environment name (lowercase, alphanumeric with hyphens)
          pattern: '^[a-z0-9-]+$'
          maxLength: 64
          example: production
        displayName:
          type: string
          description: Human-readable display name
          maxLength: 128
          example: Production Environment
        description:
          type: string
          description: Optional description of the environment
          example: Production environment for critical AI agents
        createdAt:
          type: string
          format: date-time
          description: Timestamp when the environment was created
          example: '2026-01-15T10:30:00Z'
        updatedAt:
          type: string
          format: date-time
          description: Timestamp when the environment was last updated
          example: '2026-01-20T14:45:00Z'

    CreateEnvironmentRequest:
      type: object
      required:
        - name
        - displayName
      properties:
        name:
          type: string
          description: Unique environment name (lowercase, alphanumeric with hyphens)
          pattern: '^[a-z0-9-]+$'
          minLength: 1
          maxLength: 64
          example: production
        displayName:
          type: string
          description: Human-readable display name
          minLength: 1
          maxLength: 128
          example: Production Environment
        description:
          type: string
          description: Optional description of the environment
          example: Production environment for critical AI agents

    UpdateEnvironmentRequest:
      type: object
      minProperties: 1
      properties:
        displayName:
          type: string
          description: Updated display name
          minLength: 1
          maxLength: 128
          example: Production Environment (US-East)
        description:
          type: string
          description: Updated description
          nullable: true
          example: Production environment for US East region

    EnvironmentListResponse:
      type: object
      required:
        - environments
        - total
        - limit
        - offset
      properties:
        environments:
          type: array
          items:
            $ref: '#/components/schemas/GatewayEnvironmentResponse'
        total:
          type: integer
          format: int32
          description: Total number of environments
          example: 3
        limit:
          type: integer
          format: int32
          description: Number of results per page
          example: 20
        offset:
          type: integer
          format: int32
          description: Number of results skipped
          example: 0

    # ============================================
    # GATEWAY SCHEMAS (for reference)
    # ============================================

    GatewayResponse:
      type: object
      required:
        - uuid
        - organizationId
        - name
        - displayName
        - gatewayType
        - vhost
        - isCritical
        - status
        - createdAt
        - updatedAt
      properties:
        uuid:
          type: string
          format: uuid
          description: Unique identifier for the gateway
          example: 7c4a8d09-ca3f-4b0a-82e9-2e85b96dd8a7
        organizationId:
          type: string
          format: uuid
          description: Organization UUID
          example: 123e4567-e89b-12d3-a456-426614174000
        name:
          type: string
          description: Unique gateway name
          example: ai-gateway-prod
        displayName:
          type: string
          description: Human-readable display name
          example: Production AI Gateway
        gatewayType:
          type: string
          enum:
            - INGRESS
            - EGRESS
          example: EGRESS
        controlPlaneUrl:
          type: string
          format: uri
          description: URL of the gateway's control plane
          example: https://gateway-control.example.com
        vhost:
          type: string
          description: Virtual host for the gateway
          example: api.production.example.com
        region:
          type: string
          description: Deployment region
          example: us-east-1
        isCritical:
          type: boolean
          description: Flag indicating if this is a critical production gateway
          example: true
        status:
          type: string
          enum:
            - ACTIVE
            - INACTIVE
            - PROVISIONING
            - ERROR
          example: ACTIVE
        adapterConfig:
          type: object
          description: Adapter-specific configuration
          additionalProperties: true
        createdAt:
          type: string
          format: date-time
          example: '2026-01-15T10:30:00Z'
        updatedAt:
          type: string
          format: date-time
          example: '2026-02-01T08:00:00Z'

    # ============================================
    # ERROR SCHEMAS
    # ============================================

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code or type
          example: VALIDATION_ERROR
        message:
          type: string
          description: Human-readable error message
          example: Invalid request parameters
        details:
          type: object
          description: Additional error details (optional)
          additionalProperties: true
          example:
            field: name
            reason: Name must be lowercase alphanumeric with hyphens

  responses:
    BadRequest:
      description: Bad request - invalid parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: BAD_REQUEST
            message: Invalid request parameters

    Unauthorized:
      description: Unauthorized - invalid or missing authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: UNAUTHORIZED
            message: Invalid or missing authentication token

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: NOT_FOUND
            message: Environment not found

    Conflict:
      description: Conflict - resource already exists
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: CONFLICT
            message: Environment with this name already exists

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: INTERNAL_ERROR
            message: An unexpected error occurred
